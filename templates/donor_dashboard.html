<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donor Dashboard | AarogyaMitra</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #ff7a00;
            --primary-dark: #e36c00;
            --secondary: #2c7fb8;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --gray: #6c757d;
            --light-gray: #e9ecef;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ----- NAVBAR (fixed) ----- */
        .navbar {
            width: 100%;
            height: 70px;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo img {
            height: 48px;
            color: #ff7a00;
            border-radius: 6px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
        }

        .menu {
            display: flex;
            gap: 25px;
            list-style: none;
            align-items: center;
        }

        .menu li a {
            text-decoration: none;
            font-size: 16px;
            color: var(--dark);
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .menu li a:hover {
            color: var(--primary);
        }

        .login-btn {
            padding: 8px 18px;
            border-radius: 6px;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 15px;
            transition: background 0.3s;
        }

        .profile-icon {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            cursor: pointer;
            object-fit: cover;
        }

        .dropdown-menu {
            position: absolute;
            top: 65px;
            right: 0;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            width: 200px;
            display: none;
            flex-direction: column;
            padding: 10px 0;
            z-index: 1000;
        }

        .dropdown-menu.active {
            display: flex;
        }

        .dropdown-header {
            font-weight: 600;
            color: var(--dark);
            padding: 12px 16px;
            border-bottom: 1px solid var(--light-gray);
        }

        .dropdown-menu a {
            padding: 12px 16px;
            text-decoration: none;
            color: var(--dark);
            font-size: 14px;
        }

        .dropdown-menu a:hover {
            color: var(--primary);
            border-radius: 6px;
        }

        /* ----- DASHBOARD LAYOUT ----- */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
            padding-top: 70px;
        }

        /* --- SIDEBAR — profile centered --- */
        .sidebar {
            width: 280px;
            background: #ffffff;
            padding: 32px 20px;
            box-shadow: 2px 0 16px rgba(0,0,0,0.05);
            border-radius: 0 24px 24px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .user-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            padding-bottom: 24px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--light-gray);
        }

        .user-avatar {
            position: relative;
            width: 96px;
            height: 96px;
            border-radius: 50%;
            background-color: var(--light-gray);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: var(--gray);
            overflow: visible;
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 6px 14px rgba(0,0,0,0.08);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .user-name {
            font-size: 22px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 6px;
        }

        .user-role {
            font-size: 15px;
            font-weight: 500;
            color: var(--primary);
            background: rgba(255,122,0,0.08);
            padding: 5px 16px;
            border-radius: 40px;
            display: inline-block;
        }

        .sidebar-menu {
            list-style: none;
            width: 100%;
            margin-top: 10px;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
            width: 100%;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 22px;
            text-decoration: none;
            color: var(--dark);
            border-radius: 14px;
            transition: all 0.25s ease;
            font-weight: 500;
        }

        .sidebar-menu a i {
            width: 22px;
            text-align: center;
            color: var(--gray);
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255,122,0,0.1);
            color: var(--primary);
        }

        .sidebar-menu a:hover i,
        .sidebar-menu a.active i {
            color: var(--primary);
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            padding: 35px 40px;
            background-color: #f5f7fa;
            max-width: calc(100% - 280px);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .dashboard-header h2 {
            font-size: 28px;
            color: var(--dark);
            font-weight: 600;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 40px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            font-size: 15px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: #fff;
            box-shadow: 0 4px 10px rgba(255,122,0,0.2);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(255,122,0,0.25);
        }

        /* Stats Cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 24px;
            margin-bottom: 36px;
        }

        .stat-card {
            background: #fff;
            border-radius: 20px;
            padding: 24px 22px;
            box-shadow: 0 8px 22px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
            gap: 18px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 28px rgba(0,0,0,0.08);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #fff;
        }

        .stat-icon.orange { background-color: var(--primary); }
        .stat-icon.green { background-color: var(--success); }
        .stat-icon.blue { background-color: var(--secondary); }
        .stat-icon.red { background-color: var(--danger); }

        .stat-info h3 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--dark);
        }

        .stat-info p {
            font-size: 14px;
            color: var(--gray);
            font-weight: 500;
        }

        /* Dashboard Sections */
        .dashboard-section {
            background: #fff;
            border-radius: 24px;
            padding: 28px 30px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.04);
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-gray);
        }

        .section-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .view-all {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: rgba(255,122,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 20px;
        }

        .activity-details h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--dark);
        }

        .activity-details p {
            font-size: 14px;
            color: var(--gray);
        }

        .activity-time {
            margin-left: auto;
            font-size: 13px;
            color: var(--gray);
            white-space: nowrap;
        }

        /* How to donate - steps */
        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 24px;
            margin-top: 10px;
        }

        .step-item {
            text-align: center;
            padding: 16px 8px;
            transition: all 0.2s;
            border-radius: 16px;
        }

        .step-item:hover {
            background: rgba(255,122,0,0.02);
        }

        .step-icon {
            width: 64px;
            height: 64px;
            background: rgba(255,122,0,0.08);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: var(--primary);
            font-size: 26px;
        }

        .step-item h4 {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 16px;
        }

        .step-item p {
            color: var(--gray);
            font-size: 13px;
        }

        /* Donation Overlay */
        .donation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.55);
            display: flex;
            justify-content: center;
            align-items: flex-end;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .donation-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .donation-form-container {
            background: #fff;
            width: 100%;
            max-width: 900px;
            border-radius: 28px 28px 0 0;
            padding: 35px;
            transform: translateY(100%);
            transition: transform 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
        }

        .donation-overlay.active .donation-form-container {
            transform: translateY(0);
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .form-header h3 {
            font-size: 24px;
            color: var(--dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }

        .donation-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 22px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--light-gray);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,122,0,0.1);
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .image-upload-area {
            border: 2px dashed var(--light-gray);
            border-radius: 20px;
            padding: 28px 20px;
            text-align: center;
            cursor: pointer;
            background-color: #fafafa;
            transition: all 0.2s;
        }

        .image-upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(255,122,0,0.04);
        }

        .upload-icon {
            font-size: 48px;
            color: var(--gray);
            margin-bottom: 12px;
        }

        .browse-btn {
            display: inline-block;
            padding: 8px 24px;
            background-color: var(--primary);
            color: #fff;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 12px;
        }

        .image-preview {
            display: none;
            margin-top: 18px;
            position: relative;
        }

        .image-preview.active {
            display: block;
        }

        .preview-image {
            max-width: 100%;
            max-height: 180px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 32px;
            height: 32px;
            background: var(--danger);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            border: 2px solid #fff;
        }

        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            justify-content: flex-end;
            gap: 18px;
            margin-top: 20px;
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid var(--gray);
            color: var(--gray);
            border-radius: 40px;
        }

        .btn-outline:hover {
            background: var(--light-gray);
            border-color: var(--dark);
            color: var(--dark);
        }

        /* Modal for history */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background: #fff;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            transform: translateY(-30px);
            transition: transform 0.4s ease;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 22px 28px;
            border-bottom: 1px solid var(--light-gray);
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-body {
            padding: 28px;
            overflow-y: auto;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner i {
            font-size: 40px;
            color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
        }

        .empty-state i {
            font-size: 64px;
            color: var(--gray);
            margin-bottom: 16px;
        }

        /* Context Menu for Profile Image */
        .avatar-context-menu {
            position: absolute;
            top: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            width: 180px;
            z-index: 1001;
            display: none;
            overflow: hidden;
        }

        .avatar-context-menu.active {
            display: block;
        }

        .avatar-context-menu ul {
            list-style: none;
            padding: 8px 0;
            margin: 0;
        }

        .avatar-context-menu li {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .avatar-context-menu li i {
            width: 18px;
            text-align: center;
            color: #6c757d;
        }

        .avatar-context-menu li:hover {
            background: rgba(255,122,0,0.1);
            color: var(--primary);
        }

        .avatar-context-menu li:hover i {
            color: var(--primary);
        }

        .avatar-context-menu .delete-option {
            color: #dc3545;
            border-top: 1px solid #e9ecef;
            margin-top: 4px;
        }

        .avatar-context-menu .delete-option i {
            color: #dc3545;
        }

        .avatar-context-menu .delete-option:hover {
            background: rgba(220,53,69,0.1);
            color: #dc3545;
        }

        .avatar-context-menu .delete-option:hover i {
            color: #dc3545;
        }

        .context-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 1000;
            display: none;
        }

        .context-menu-overlay.active {
            display: block;
        }

        @media (max-width: 992px) {
            .dashboard-container { flex-direction: column; }
            .sidebar { width: 100%; border-radius: 0; }
            .main-content { max-width: 100%; padding: 25px; }
        }

        @media (max-width: 640px) {
            .stats-cards { grid-template-columns: 1fr; }
            .donation-form { grid-template-columns: 1fr; }
        }

        #imageInput { display: none; }
    </style>
</head>
<body>
    <!-- Authentication check - redirects to login if not logged in -->
    {% if not session.user %}
    <script>
        window.location.href = "{{ url_for('login_page') }}";
    </script>
    {% endif %}

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="logo">
            <img src="/static/img/logo.png" alt="logo">
            <span class="logo-text">AarogyaMitra</span>
        </div>
        <ul class="menu">
            <li><a href="/">Home</a></li>
            <li><a href="/#about">About</a></li>
            <li><a href="/#medicines">Available Medicines</a></li>
            <li><a href="/#contact">Contact</a></li>
            <li style="position: relative;">
                <img src="{% if user and user.profile_image %}/static/profile_images/{{ user.profile_image }}?t={{ range(1, 100000) | random }}{% else %}https://cdn-icons-png.flaticon.com/512/847/847969.png{% endif %}" 
                     alt="Profile" 
                     class="profile-icon" 
                     id="navbarProfileIcon"
                     onerror="this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png'"
                     onclick="toggleDropdown()">
                <div class="dropdown-menu" id="profileMenu">
                    <div class="dropdown-header" id="dropdown-username">{{ user.username }}</div>
                    <a href="/{{ session.user.user_type }}/dashboard">My Profile</a>
                    <a href="/setting">Setting</a>
                    <a href="/logout" style="color:red;">Logout</a>
                </div>
            </li>
        </ul>
    </nav>

    <!-- DASHBOARD CONTAINER -->
    <div class="dashboard-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="user-profile">
                <div class="user-avatar" id="avatarBox">
                    <img id="avatarPreview" 
                         src="{% if user and user.profile_image %}/static/profile_images/{{ user.profile_image }}?t={{ range(1, 100000) | random }}{% else %}https://cdn-icons-png.flaticon.com/512/847/847969.png{% endif %}" 
                         style="width:100%; height:100%; border-radius:50%; object-fit:cover;"
                         onerror="this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png'">
                    <input type="file" id="avatarInput" accept="image/*" style="display:none;">
                    
                    <!-- Right-click Context Menu for Profile Image -->
                    <div class="avatar-context-menu" id="avatarContextMenu">
                        <ul>
                            <li id="changePhotoOption"><i class="fas fa-camera"></i> Change Photo</li>
                            <li id="deletePhotoOption" class="delete-option"><i class="fas fa-trash"></i> Delete Photo</li>
                        </ul>
                    </div>
                </div>
                <h3 class="user-name" id="sidebar-username">{{ user.username }}</h3>
                <span class="user-role" id="sidebar-userrole">Medicine {{ user.user_type|capitalize }}</span>
            </div>

            <ul class="sidebar-menu">
                <li><a href="#" class="active" id="dashboard-link"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="#" id="sidebar-donate-btn"><i class="fas fa-pills"></i> Donate Medicine</a></li>
                <li><a href="#" id="donation-history-link"><i class="fas fa-history"></i> Donation History</a></li>
            </ul>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="dashboard-header">
                <h2>Donor Dashboard</h2>
                <button class="btn btn-primary" id="donate-btn"><i class="fas fa-plus"></i> Donate Medicine</button>
            </div>

            <!-- Stats Cards - Will be populated dynamically -->
            <div class="stats-cards" id="stats-cards-container">
                <div class="stat-card">
                    <div class="stat-icon orange"><i class="fas fa-pills"></i></div>
                    <div class="stat-info">
                        <h3 id="total-donated">0</h3>
                        <p>Medicines Donated</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info">
                        <h3 id="successful-donations">0</h3>
                        <p>Successful Donations</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon blue"><i class="fas fa-hand-holding-heart"></i></div>
                    <div class="stat-info">
                        <h3 id="pending-donations">0</h3>
                        <p>Pending Donations</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon red"><i class="fas fa-users"></i></div>
                    <div class="stat-info">
                        <h3 id="lives-impacted">0</h3>
                        <p>Lives Impacted</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3>Recent Activity</h3>
                    <a href="#" class="view-all" id="view-all-activity">View All</a>
                </div>
                <div id="recent-activity-container">
                    <ul class="activity-list" id="activity-list">
                        <!-- Will be populated dynamically -->
                        <li class="activity-item" style="justify-content: center; padding: 40px;">
                            <div style="text-align: center; width: 100%;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary);"></i>
                                <p style="margin-top: 15px; color: var(--gray);">Loading recent activity...</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- How to Donate Medicine -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3>How to Donate Medicine</h3>
                </div>
                <div class="steps-grid">
                    <div class="step-item">
                        <div class="step-icon"><i class="fas fa-pills"></i></div>
                        <h4>Check Expiry</h4>
                        <p>At least 3 months before expiry</p>
                    </div>
                    <div class="step-item">
                        <div class="step-icon"><i class="fas fa-camera"></i></div>
                        <h4>Take Photo</h4>
                        <p>Clear image of packaging</p>
                    </div>
                    <div class="step-item">
                        <div class="step-icon"><i class="fas fa-list"></i></div>
                        <h4>Provide Details</h4>
                        <p>Accurate medicine info</p>
                    </div>
                    <div class="step-item">
                        <div class="step-icon"><i class="fas fa-truck"></i></div>
                        <h4>Schedule Pickup</h4>
                        <p>Volunteer collects</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DONATION FORM OVERLAY -->
    <div class="donation-overlay" id="donation-overlay">
        <div class="donation-form-container">
            <div class="form-header">
                <h3>Donate Medicine</h3>
                <button class="close-btn" id="close-form">&times;</button>
            </div>
            <form class="donation-form" id="donation-form" enctype="multipart/form-data">
                <div class="form-group full-width">
                    <div class="image-upload-area" id="uploadArea">
                        <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                        <div class="upload-text">
                            <h4>Upload Medicine Image</h4>
                            <p>Drag & drop or click to upload</p>
                        </div>
                        <div class="browse-btn" id="browseBtn">Browse Files</div>
                        <input type="file" id="imageInput" name="image" accept="image/*">
                    </div>
                    <div class="image-preview" id="imagePreview">
                        <div class="preview-container" style="position:relative; display:inline-block;">
                            <img src="" alt="Preview" class="preview-image" id="previewImage">
                            <div class="remove-image" id="removeImage">&times;</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="medicineName">Medicine Name *</label>
                    <input type="text" id="medicineName" name="medicineName" class="form-control" placeholder="Enter medicine name" required>
                </div>
                <div class="form-group">
                    <label for="manufacturer">Manufacturer *</label>
                    <input type="text" id="manufacturer" name="manufacturer" class="form-control" placeholder="Manufacturer" required>
                </div>
                <div class="form-group">
                    <label for="expiryDate">Expiry Date *</label>
                    <input type="date" id="expiryDate" name="expiryDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="quantity">Quantity *</label>
                    <input type="number" id="quantity" name="quantity" class="form-control" placeholder="Number of units" required min="1">
                </div>
                <div class="form-group">
                    <label for="category">Category *</label>
                    <select id="category" name="category" class="form-control" required>
                        <option value="">Select</option>
                        <option value="tablets">Tablets</option>
                        <option value="syrup">Syrup</option>
                        <option value="ointment">Ointment</option>
                        <option value="injection">Injection</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="condition">Condition *</label>
                    <select id="condition" name="condition" class="form-control" required>
                        <option value="">Select condition</option>
                        <option value="sealed">Sealed/Unopened</option>
                        <option value="good">Good Condition</option>
                        <option value="fair">Fair Condition</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label for="description">Additional Details</label>
                    <textarea id="description" name="description" class="form-control" placeholder="Any additional information..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancel-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submit-donation-btn">Submit Donation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- DONATION HISTORY MODAL -->
    <div class="modal-overlay" id="history-modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3><i class="fas fa-history" style="margin-right: 12px; color: var(--primary);"></i> Your Donation History</h3>
                <button class="modal-close-btn" id="close-history-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                    <select id="history-filter-modal" class="form-control" style="width: auto; padding: 8px 18px; border-radius:40px;">
                        <option value="all">All Donations</option>
                        <option value="available">Available</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="collected">Collected</option>
                        <option value="completed">Completed</option>
                    </select>
                    <button class="btn btn-outline" id="refresh-history-modal-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div id="history-modal-loading" class="loading-spinner" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p style="margin-top: 16px;">Loading your donation history...</p>
                </div>
                <div id="history-modal-content">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            // ============================================
            // BACKEND INTEGRATION
            // ============================================

            // Current user info with profile_image
            const CURRENT_USER = {
                username: {{ user.username|tojson|safe }},
                user_type: {{ user.user_type|tojson|safe }},
                user_id: {% if user._id %}{{ user._id|string|tojson|safe }}{% else %}null{% endif %},
                profile_image: {% if user.profile_image %}{{ user.profile_image|tojson|safe }}{% else %}null{% endif %}
            };

            const API_BASE = '';

            // ========== PROFILE IMAGE UPLOAD WITH RIGHT-CLICK DELETE ==========
            const avatarBox = document.getElementById('avatarBox');
            const avatarInput = document.getElementById('avatarInput');
            const avatarPreview = document.getElementById('avatarPreview');
            const navbarProfileIcon = document.getElementById('navbarProfileIcon');
            const avatarContextMenu = document.getElementById('avatarContextMenu');
            const changePhotoOption = document.getElementById('changePhotoOption');
            const deletePhotoOption = document.getElementById('deletePhotoOption');

            // Create overlay for closing context menu
            const contextMenuOverlay = document.createElement('div');
            contextMenuOverlay.className = 'context-menu-overlay';
            document.body.appendChild(contextMenuOverlay);

            // ===== RIGHT CLICK ON AVATAR TO SHOW CONTEXT MENU =====
            if (avatarBox) {
                avatarBox.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Close any other open menus
                    avatarContextMenu.classList.add('active');
                    contextMenuOverlay.classList.add('active');
                });
            }

            // ===== CLOSE CONTEXT MENU WHEN CLICKING OUTSIDE =====
            contextMenuOverlay.addEventListener('click', function() {
                avatarContextMenu.classList.remove('active');
                contextMenuOverlay.classList.remove('active');
            });

            // ===== CHANGE PHOTO OPTION =====
            if (changePhotoOption) {
                changePhotoOption.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Close context menu
                    avatarContextMenu.classList.remove('active');
                    contextMenuOverlay.classList.remove('active');
                    
                    // Trigger file input
                    avatarInput.click();
                });
            }

            // ===== DELETE PHOTO OPTION =====
            if (deletePhotoOption) {
                deletePhotoOption.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Close context menu
                    avatarContextMenu.classList.remove('active');
                    contextMenuOverlay.classList.remove('active');
                    
                    // Check if current image is default
                    const currentSrc = avatarPreview.src;
                    if (currentSrc.includes('cdn-icons-png') || currentSrc.includes('default')) {
                        alert('No profile image to delete');
                        return;
                    }
                    
                    // Confirm deletion
                    if (confirm('Are you sure you want to delete your profile photo?')) {
                        await deleteProfileImage();
                    }
                });
            }

            // ===== DELETE PROFILE IMAGE FUNCTION =====
            async function deleteProfileImage() {
                try {
                    const response = await fetch('/delete_profile_image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Add cache-busting parameter
                        const timestamp = new Date().getTime();
                        const defaultImage = result.default_image + '?t=' + timestamp;
                        
                        // Update both images to default
                        avatarPreview.src = defaultImage;
                        if (navbarProfileIcon) navbarProfileIcon.src = defaultImage;
                        
                        // Update CURRENT_USER object
                        CURRENT_USER.profile_image = null;
                        
                        alert('Profile image deleted successfully!');
                        console.log('✅ Profile image deleted');
                    } else {
                        alert(result.message || 'Failed to delete profile image');
                    }
                } catch (error) {
                    console.error('❌ Error deleting profile image:', error);
                    alert('Error deleting image. Please try again.');
                }
            }

            // ===== CLICK ON AVATAR TO UPLOAD NEW IMAGE =====
            if (avatarBox) {
                avatarBox.addEventListener('click', function(e) {
                    // Don't open file picker if right-click
                    if (e.button === 2) return;
                    avatarInput.click();
                });
            }

            // ===== FILE INPUT CHANGE HANDLER =====
            if (avatarInput) {
                avatarInput.addEventListener('change', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (this.files && this.files[0]) {
                        const file = this.files[0];
                        
                        // Validate file
                        if (file.size > 5 * 1024 * 1024) {
                            alert('File too large! Max size is 5MB.');
                            this.value = '';
                            return;
                        }
                        
                        if (!file.type.match('image.*')) {
                            alert('Please select an image file (PNG, JPG, JPEG, GIF)');
                            this.value = '';
                            return;
                        }
                        
                        // Show loading state
                        const originalSrc = avatarPreview.src;
                        const loadingGif = 'https://i.gifer.com/ZZ5H.gif';
                        avatarPreview.src = loadingGif;
                        if (navbarProfileIcon) navbarProfileIcon.src = loadingGif;
                        
                        // Create FormData
                        const formData = new FormData();
                        formData.append('profileImage', file);
                        
                        try {
                            console.log('Uploading profile image...');
                            const response = await fetch('/upload_profile', {
                                method: 'POST',
                                body: formData
                            });
                            
                            const result = await response.json();
                            console.log('Upload result:', result);
                            
                            if (result.success) {
                                // Add cache-busting parameter
                                const timestamp = new Date().getTime();
                                const newImageUrl = `/static/profile_images/${result.filename}?t=${timestamp}`;
                                
                                // Update both images
                                avatarPreview.src = newImageUrl;
                                if (navbarProfileIcon) navbarProfileIcon.src = newImageUrl;
                                
                                // Update CURRENT_USER object
                                CURRENT_USER.profile_image = result.filename;
                                
                                alert('Profile image updated successfully!');
                                console.log('✅ Profile image uploaded successfully:', result.filename);
                            } else {
                                alert(result.message || 'Failed to upload profile image');
                                // Revert to original
                                avatarPreview.src = originalSrc;
                                if (navbarProfileIcon) navbarProfileIcon.src = originalSrc;
                            }
                        } catch (error) {
                            console.error('❌ Error uploading profile image:', error);
                            alert('Error uploading image. Please try again.');
                            // Revert to original
                            avatarPreview.src = originalSrc;
                            if (navbarProfileIcon) navbarProfileIcon.src = originalSrc;
                        } finally {
                            // Clear the input so the same file can be uploaded again
                            this.value = '';
                        }
                    }
                });
            }

            // ===== FORCE RELOAD IMAGES ON PAGE LOAD =====
            window.addEventListener('load', function() {
                const timestamp = new Date().getTime();
                
                // Update avatar preview if it has a profile image
                if (avatarPreview && avatarPreview.src.includes('/static/profile_images/')) {
                    const baseUrl = avatarPreview.src.split('?')[0];
                    if (baseUrl && !baseUrl.includes('cdn-icons-png')) {
                        avatarPreview.src = baseUrl + '?t=' + timestamp;
                    }
                }
                
                // Update navbar icon if it has a profile image
                if (navbarProfileIcon && navbarProfileIcon.src.includes('/static/profile_images/')) {
                    const baseUrl = navbarProfileIcon.src.split('?')[0];
                    if (baseUrl && !baseUrl.includes('cdn-icons-png')) {
                        navbarProfileIcon.src = baseUrl + '?t=' + timestamp;
                    }
                }
            });

            // ===== ERROR HANDLERS FOR IMAGES =====
            if (avatarPreview) {
                avatarPreview.addEventListener('error', function() {
                    console.log('Avatar image failed to load, using default');
                    this.src = 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
                });
            }

            if (navbarProfileIcon) {
                navbarProfileIcon.addEventListener('error', function() {
                    console.log('Navbar profile image failed to load, using default');
                    this.src = 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
                });
            }

            // ========== LOAD DONOR STATISTICS ==========
            async function loadDonorStats() {
                try {
                    const statElements = {
                        total: document.getElementById('total-donated'),
                        successful: document.getElementById('successful-donations'),
                        pending: document.getElementById('pending-donations'),
                        lives: document.getElementById('lives-impacted')
                    };

                    Object.values(statElements).forEach(el => { if (el) el.innerText = '...'; });

                    const response = await fetch(API_BASE + '/get_donor_stats');
                    const data = await response.json();

                    if (data.success) {
                        if (statElements.total) statElements.total.innerText = data.stats.total_donated || 0;
                        if (statElements.successful) statElements.successful.innerText = data.stats.successful || 0;
                        if (statElements.pending) statElements.pending.innerText = data.stats.pending || 0;
                        if (statElements.lives) statElements.lives.innerText = data.stats.lives_impacted || 0;
                    } else {
                        throw new Error(data.message || 'Failed to load stats');
                    }
                } catch (error) {
                    console.error('Error loading donor stats:', error);
                    setDefaultStats();
                }
            }

            function setDefaultStats() {
                const statElements = {
                    total: document.getElementById('total-donated'),
                    successful: document.getElementById('successful-donations'),
                    pending: document.getElementById('pending-donations'),
                    lives: document.getElementById('lives-impacted')
                };
                if (statElements.total) statElements.total.innerText = '0';
                if (statElements.successful) statElements.successful.innerText = '0';
                if (statElements.pending) statElements.pending.innerText = '0';
                if (statElements.lives) statElements.lives.innerText = '0';
            }

            // ========== LOAD RECENT ACTIVITY ==========
            async function loadRecentActivity() {
                const activityList = document.getElementById('activity-list');
                if (!activityList) return;

                try {
                    activityList.innerHTML = `
                        <li class="activity-item" style="justify-content: center; padding: 40px;">
                            <div style="text-align: center; width: 100%;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary);"></i>
                                <p style="margin-top: 15px; color: var(--gray);">Loading recent activity...</p>
                            </div>
                        </li>
                    `;

                    const response = await fetch(API_BASE + '/get_recent_activity');
                    const data = await response.json();

                    if (data.success) {
                        const activities = data.activities || [];
                        
                        if (activities.length === 0) {
                            activityList.innerHTML = `
                                <li class="activity-item" style="justify-content: center; padding: 40px;">
                                    <div style="text-align: center; width: 100%;">
                                        <i class="fas fa-box-open" style="font-size: 48px; color: #6c757d; margin-bottom: 15px;"></i>
                                        <h4 style="color: #6c757d; font-size: 18px; margin-bottom: 8px;">No donations yet</h4>
                                        <p style="color: #6c757d; font-size: 14px;">Click "Donate Medicine" to make your first donation</p>
                                    </div>
                                </li>
                            `;
                        } else {
                            activityList.innerHTML = '';
                            activities.forEach(activity => {
                                const item = createActivityItem(activity);
                                activityList.appendChild(item);
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading recent activity:', error);
                }
            }

            // Helper function to create activity item
            function createActivityItem(activity) {
                const li = document.createElement('li');
                li.className = 'activity-item';

                let icon = 'fa-pills';
                let iconColor = '#ff7a00';
                let statusText = activity.status || 'donated';

                if (['completed', 'collected', 'delivered'].includes(activity.status)) {
                    icon = 'fa-check-circle';
                    iconColor = '#28a745';
                    statusText = 'completed';
                } else if (['pending', 'available'].includes(activity.status)) {
                    icon = 'fa-clock';
                    iconColor = '#2c7fb8';
                    statusText = 'pending';
                } else if (activity.status === 'approved') {
                    icon = 'fa-check';
                    iconColor = '#ff7a00';
                    statusText = 'approved';
                }

                const expiryDate = activity.expiry_date ? new Date(activity.expiry_date).toLocaleDateString() : 'N/A';
                const timeAgo = activity.time_ago || activity.donated_on || 'Recently';

                li.innerHTML = `
                    <div class="activity-icon" style="background-color: ${iconColor}15; color: ${iconColor};">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="activity-details">
                        <h4 style="text-transform: capitalize; color: #343a40;">${activity.medicine_name || 'Medicine'}</h4>
                        <p style="margin-bottom: 4px;">
                            <span style="font-weight: 500;">${activity.quantity || 0} units</span> • 
                            <span style="color: #6c757d;">Expires: ${expiryDate}</span>
                        </p>
                        <small style="color: ${iconColor}; font-weight: 500; text-transform: capitalize;">
                            <i class="fas fa-circle" style="font-size: 8px; margin-right: 4px;"></i>
                            Status: ${statusText}
                        </small>
                    </div>
                    <div class="activity-time">
                        <i class="far fa-clock" style="margin-right: 4px;"></i>
                        ${timeAgo}
                    </div>
                `;
                return li;
            }

            // ========== LOAD DONATION HISTORY ==========
            async function loadDonationHistoryModal(filter = 'all') {
                const modalContent = document.getElementById('history-modal-content');
                const loadingEl = document.getElementById('history-modal-loading');
                
                if (!modalContent) return;

                loadingEl.style.display = 'block';
                modalContent.style.display = 'none';

                try {
                    const response = await fetch(API_BASE + '/get_all_donations');
                    const data = await response.json();

                    if (data.success) {
                        let donations = data.donations || [];

                        if (filter !== 'all') {
                            donations = donations.filter(d => d.status === filter);
                        }

                        donations.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                        let html = '';

                        if (donations.length === 0) {
                            html = `
                                <div class="empty-state">
                                    <i class="fas fa-box-open"></i>
                                    <h3 style="color: var(--dark); margin-bottom: 10px;">No donation history found</h3>
                                    <p style="color: var(--gray); margin-bottom: 20px;">You haven't made any donations yet.</p>
                                    <button class="btn btn-primary" id="history-modal-donate-btn">
                                        <i class="fas fa-plus"></i> Donate Medicine Now
                                    </button>
                                </div>
                            `;
                        } else {
                            html = `
                                <div style="margin-bottom: 20px;">
                                    <p style="color: var(--gray);">
                                        <i class="fas fa-info-circle"></i> 
                                        Showing ${donations.length} donation${donations.length > 1 ? 's' : ''}
                                    </p>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background-color: var(--light-gray);">
                                                <th style="padding: 14px; text-align: left;">Medicine</th>
                                                <th style="padding: 14px; text-align: left;">Quantity</th>
                                                <th style="padding: 14px; text-align: left;">Expiry Date</th>
                                                <th style="padding: 14px; text-align: left;">Status</th>
                                                <th style="padding: 14px; text-align: left;">Donated On</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;

                            donations.forEach(donation => {
                                let statusColor, statusBg;
                                switch (donation.status) {
                                    case 'completed':
                                    case 'delivered':
                                    case 'collected':
                                        statusColor = '#28a745';
                                        statusBg = '#e8f5e9';
                                        break;
                                    case 'pending':
                                        statusColor = '#ffc107';
                                        statusBg = '#fff9e6';
                                        break;
                                    case 'approved':
                                        statusColor = '#2c7fb8';
                                        statusBg = '#e6f3ff';
                                        break;
                                    case 'available':
                                        statusColor = '#6c757d';
                                        statusBg = '#f8f9fa';
                                        break;
                                    default:
                                        statusColor = '#ff7a00';
                                        statusBg = '#fff1e6';
                                }

                                const donatedDate = donation.created_at ? new Date(donation.created_at).toLocaleDateString() : 'N/A';
                                const expiryDate = donation.expiry_date ? new Date(donation.expiry_date).toLocaleDateString() : 'N/A';

                                html += `
                                    <tr style="border-bottom: 1px solid var(--light-gray);">
                                        <td style="padding: 14px; font-weight: 500;">
                                            <i class="fas fa-pills" style="color: var(--primary); margin-right: 8px;"></i>
                                            ${donation.medicine_name || 'Medicine'}
                                        </td>
                                        <td style="padding: 14px;">${donation.quantity || 0} units</td>
                                        <td style="padding: 14px;">${expiryDate}</td>
                                        <td style="padding: 14px;">
                                            <span style="background-color: ${statusBg}; color: ${statusColor}; padding: 5px 14px; border-radius: 40px; font-size: 13px; font-weight: 500; text-transform: capitalize;">
                                                ${donation.status || 'Donated'}
                                            </span>
                                        </td>
                                        <td style="padding: 14px; color: var(--gray);">
                                            ${donation.time_ago || donatedDate}
                                        </td>
                                    </tr>
                                `;
                            });

                            html += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }

                        modalContent.innerHTML = html;

                        const donateBtn = document.getElementById('history-modal-donate-btn');
                        if (donateBtn) {
                            donateBtn.addEventListener('click', function() {
                                closeHistoryModal();
                                openDonationForm();
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading donation history:', error);
                } finally {
                    loadingEl.style.display = 'none';
                    modalContent.style.display = 'block';
                }
            }

            // ========== SUBMIT DONATION ==========
            async function submitDonation(formData) {
                try {
                    const response = await fetch(API_BASE + '/submit_donation', {
                        method: 'POST',
                        body: formData
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Error submitting donation:', error);
                    throw error;
                }
            }

            // ========== UI CONTROLLERS ==========
            const donationOverlay = document.getElementById('donation-overlay');
            const donateBtn = document.getElementById('donate-btn');
            const sidebarDonateBtn = document.getElementById('sidebar-donate-btn');
            const closeFormBtn = document.getElementById('close-form');
            const cancelBtn = document.getElementById('cancel-btn');
            const donationForm = document.getElementById('donation-form');

            function openDonationForm() {
                donationOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                const expiryInput = document.getElementById('expiryDate');
                if (expiryInput) {
                    const today = new Date().toISOString().split('T')[0];
                    expiryInput.min = today;
                }
            }

            function closeDonationForm() {
                donationOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
                if (donationForm) donationForm.reset();
                if (imagePreview) imagePreview.classList.remove('active');
                if (imageInput) imageInput.value = '';
            }

            // Image Upload
            const uploadArea = document.getElementById('uploadArea');
            const browseBtn = document.getElementById('browseBtn');
            const imageInput = document.getElementById('imageInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            const removeImage = document.getElementById('removeImage');

            if (browseBtn) {
                browseBtn.addEventListener('click', () => imageInput.click());
            }

            if (imageInput) {
                imageInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const file = this.files[0];
                        if (file.size > 5 * 1024 * 1024) {
                            alert('File too large (max 5MB)');
                            return;
                        }
                        if (!file.type.match('image.*')) {
                            alert('Please select an image');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImage.src = e.target.result;
                            imagePreview.classList.add('active');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            if (removeImage) {
                removeImage.addEventListener('click', function() {
                    imageInput.value = '';
                    imagePreview.classList.remove('active');
                });
            }

            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        imageInput.files = e.dataTransfer.files;
                        const file = e.dataTransfer.files[0];
                        if (file.size > 5 * 1024 * 1024) {
                            alert('File too large (max 5MB)');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            previewImage.src = ev.target.result;
                            imagePreview.classList.add('active');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            if (donationForm) {
                donationForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const submitBtn = document.getElementById('submit-donation-btn');
                    const originalText = submitBtn.innerText;
                    submitBtn.innerText = 'Submitting...';
                    submitBtn.disabled = true;

                    try {
                        const formData = new FormData(this);
                        const result = await submitDonation(formData);

                        if (result.success) {
                            alert('Donation submitted successfully!');
                            closeDonationForm();
                            await loadDonorStats();
                            await loadRecentActivity();
                        } else {
                            alert(result.message || 'Failed to submit donation');
                        }
                    } catch (error) {
                        alert('Error submitting donation. Please try again.');
                    } finally {
                        submitBtn.innerText = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }

            if (donateBtn) donateBtn.addEventListener('click', openDonationForm);
            if (sidebarDonateBtn) sidebarDonateBtn.addEventListener('click', openDonationForm);
            if (closeFormBtn) closeFormBtn.addEventListener('click', closeDonationForm);
            if (cancelBtn) cancelBtn.addEventListener('click', closeDonationForm);

            if (donationOverlay) {
                donationOverlay.addEventListener('click', function(e) {
                    if (e.target === donationOverlay) {
                        closeDonationForm();
                    }
                });
            }

            // Profile Dropdown
            window.toggleDropdown = function() {
                const menu = document.getElementById('profileMenu');
                if (menu) menu.classList.toggle('active');
            };

            window.onclick = function(event) {
                if (!event.target.matches('.profile-icon')) {
                    const dropdowns = document.getElementsByClassName('dropdown-menu');
                    for (let d of dropdowns) {
                        d.classList.remove('active');
                    }
                }
            };

            // Donation History Modal
            const historyModalOverlay = document.getElementById('history-modal-overlay');
            const closeHistoryModalBtn = document.getElementById('close-history-modal');
            const donationHistoryLink = document.getElementById('donation-history-link');
            const refreshHistoryBtn = document.getElementById('refresh-history-modal-btn');
            const historyFilter = document.getElementById('history-filter-modal');

            function openHistoryModal() {
                if (historyModalOverlay) {
                    historyModalOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    loadDonationHistoryModal('all');
                }
            }

            function closeHistoryModal() {
                if (historyModalOverlay) {
                    historyModalOverlay.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            }

            if (donationHistoryLink) {
                donationHistoryLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openHistoryModal();
                });
            }

            if (closeHistoryModalBtn) {
                closeHistoryModalBtn.addEventListener('click', closeHistoryModal);
            }

            if (historyModalOverlay) {
                historyModalOverlay.addEventListener('click', (e) => {
                    if (e.target === historyModalOverlay) {
                        closeHistoryModal();
                    }
                });
            }

            if (refreshHistoryBtn) {
                refreshHistoryBtn.addEventListener('click', function() {
                    const filter = historyFilter ? historyFilter.value : 'all';
                    loadDonationHistoryModal(filter);
                });
            }

            if (historyFilter) {
                historyFilter.addEventListener('change', function() {
                    loadDonationHistoryModal(this.value);
                });
            }

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (donationOverlay?.classList.contains('active')) {
                        closeDonationForm();
                    }
                    if (historyModalOverlay?.classList.contains('active')) {
                        closeHistoryModal();
                    }
                    if (avatarContextMenu?.classList.contains('active')) {
                        avatarContextMenu.classList.remove('active');
                        contextMenuOverlay.classList.remove('active');
                    }
                }
            });

            const viewAllActivity = document.getElementById('view-all-activity');
            if (viewAllActivity) {
                viewAllActivity.addEventListener('click', (e) => {
                    e.preventDefault();
                    openHistoryModal();
                });
            }

            // ========== INITIALIZATION ==========
            document.addEventListener('DOMContentLoaded', function() {
                setDefaultStats();
                loadDonorStats();
                loadRecentActivity();

                const usernameElements = document.querySelectorAll('#sidebar-username, #dropdown-username');
                usernameElements.forEach(el => {
                    if (el) el.innerText = CURRENT_USER.username;
                });

                const roleElement = document.getElementById('sidebar-userrole');
                if (roleElement && CURRENT_USER.user_type) {
                    roleElement.innerText = 'Medicine ' + CURRENT_USER.user_type.charAt(0).toUpperCase() + CURRENT_USER.user_type.slice(1);
                }
            });
        })();
    </script>
</body>
</html>